{% load i18n %}

<!-- move to external file or something? -->
<script type="text/javascript">
  /* for localization */
  var stream_texts = {
    'deleteBlock': '{% trans "Are you sure, that you want to delete this block?" %}',
    'deleteInstance': '{% trans "Are you sure, that you want to delete this subblock?" %}'
  }
</script>

{# Actual vue app #}
<div class="streamfield_app" id="app_{{ widget.name }}" v-cloak>
  <div class="stream-help-text">
    <div class="stream-help-text__title" @click="show_help = !show_help">{% trans "Help?" %}</div>
    <div v-if="show_help" class="stream-help-text__content">
      {% include "streamfield/streamfield_admin_help.html" %}
    </div>
  </div>

  <div class="streamfield-models">
    <draggable v-model="stream" group="stream" handle=".block-move">
      <div v-for="block in stream" class="stream-model-block" :key="block.unique_id">
        <h3 class="streamblock__block__title"><span v-text="getMetadata(block, 'verbose_name')"></span>
          <span class="streamblock__block-handle">
            <span class="block-move"></span>
            <span class="block-delete" @click="deleteBlock(block.unique_id)"></span>
          </span>
        </h3>

        <div v-if="getMetadata(block, 'as_list')" class="stream-model-block__content" :id="'id_' + block.unique_id">

          <draggable v-model="block.id" group="items" handle=".subblock-move">
            <span v-for="item_id in block.object_id" class="stream-model-subblock">
              <span class="model-field-content" :id="'id_' + instance_unique_id(block, item_id)" v-html="getBlockContent(block, item_id)"></span>

              <span class="stream-model-subblock-handle">
                <span class="subblock-move"></span>
                <span class="subblock-delete" @click="deleteInstance(block.unique_id, item_id)"></span>
              </span>

              <a class="stream-btn" :id="'change_id_' + instance_unique_id(block, item_id)" title="{% trans 'Change' %}"
                 :href="get_change_model_link(block, item_id)" :data-block="block.unique_id" :data-instance-id="item_id" @click.prevent="openPopup">
                {% trans "Change" %}
              </a>

              &nbsp;

            </span>
          </draggable>

          <a class="stream-btn" :id="'add_id_' + block.unique_id" title="{% trans 'Add one more' %}" :href="get_add_model_link(block)" @click.prevent="openPopup">
            + {% trans "Add one more" %}
          </a>
        </div>

        <div v-else class="stream-model-block__content no-subblocks">
          <span v-for="item_id in block.object_id">
            <span class="model-field-content" :id="'id_' + instance_unique_id(block, item_id)" v-html="getBlockContent(block, item_id)"></span>

            <a class="stream-btn" :id="'change_id_' + instance_unique_id(block, item_id)" title="{% trans 'Change' %}" :href="get_change_model_link(block, item_id)"
               :data-block="block.unique_id"
               :data-instance-id="item_id"
               @click.prevent="openPopup">

               {% trans "Change" %}
            </a>
          </span>

          <span v-if="!block.object_id.length">
            <a class="stream-btn" :id="'add_id_' + block.unique_id" title="{% trans 'Add content' %}" :href="get_add_model_link(block)"
               @click.prevent="openPopup">
              + {% trans "Add content" %}
            </a>
          </span>
        </div>

        <div class="stream-block__options" v-if="hasOptions(block)">
          <div class="stream-block__option" v-for="(option, key) in getMetadata(block, 'options')">
            <template v-if="option.type == 'checkbox'">
              <span v-text="option.label"></span>: <input type="checkbox" v-model="block.options[key]">
            </template>
            <template v-else-if="option.type == 'select'">
              <span v-text="option.label"></span>:
              <select :name="option.label" v-model="block.options[key]">
                <option v-for="opt in option.options" :value="opt.value" v-text="opt.name"></option>
              </select>
            </template>
          </div>
        </div>
      </div>
    </draggable>
    <div class="stream-insert-new-block">
      <h3>{% trans "Add new block" %}</h3>
      <ul>
        <li v-for="model in models">
          <a class="stream-btn" href="#" v-text="'+ ' + model.verbose_name" @click.prevent="addNewBlock(model)"></a>
        </li>
      </ul>
    </div>
  </div>

  <textarea
    v-text="textarea" name="{{ widget.name }}" data-render_url="{% url 'streamfield:admin-render' %}"
    data-delete_url="{% url 'streamfield:delete' %}" data-base_admin_url="{% url 'admin:index' %}"
    {% include 'django/forms/widgets/attrs.html' %}>

    {% if widget.value %}{{ widget.value }}{% endif %}

  </textarea>
</div>